<!-- Bouton en haut -->
<h3 style="margin: 20px; margin-top: 40px;">
    Interface sql DOIT ETRE accessible que par ADMIN
    <br>
    API_URL : {{apiUrl}}
</h3>

<div style="width: 100%; margin: 10px;">
    {{infos}}
</div>

<div style="display: flex; margin: 20px;">
    <button (click)="getTables()">Get All Table Names</button>
</div>

<!-- Section table sélectionnée -->
<h3 *ngIf="selectedTable" style="width: 100%; margin-left: 20px;">
    Table: {{ selectedTable }}

    <div style="margin-top: 10px;">

        <button class="btn btn-primary" (click)="addTableLike()">Add Table Like</button>
        <button class="btn btn-success" (click)="startEditSelectedRow()">Update Selected Row</button>
        <button class="btn btn-info" (click)="insertLikeSelectedRow()">Insert Like Selected</button>
        <button class="btn btn-primary" (click)="insertRow()">Insert Empty Row</button>

        <button class="btn btn-danger" (click)="confirmDeleteTable()">Delete Table</button>
        <button class="btn btn-danger" (click)="deleteSelectedRow()">Delete Selected Row</button>

        <div *ngIf="isEditing || isInserting" style="margin-top: 10px;">
            <button class="btn btn-primary" (click)="saveRow()">Save</button>
            <button class="btn btn-secondary" (click)="cancelEdit()">Cancel</button>
        </div>

    </div>
</h3>

<!-- Layout principal -->
<div class="side-container" *ngIf="tables && tables.length">

    <!-- Liste tables -->
    <div #leftPanel class="side-left cadre">
        <ol>
            <li *ngFor="let table of tables" (click)="selectTable(table)" [style.cursor]="'pointer'"
                [ngClass]="getClassOfTable(table)">
                {{ table }}
            </li>
        </ol>
    </div>

    <div class="resizer cadre" (mousedown)="startResizing($event)"></div>

    <!-- Onglets Data / Relations -->
    <div class="side-right cadre">

        <div class="tabs-header">
            <button class="btn" [ngClass]="{ 'btn-primary': activeTab === 'data', 'btn-light': activeTab !== 'data' }"
                (click)="activeTab = 'data'">
                Data
            </button>

            <button class="btn"
                [ngClass]="{ 'btn-primary': activeTab === 'relations', 'btn-light': activeTab !== 'relations' }"
                (click)="openRelations()">
                Relations
            </button>

            <button class="btn"
                [ngClass]="{ 'btn-primary': activeTab === 'structure', 'btn-light': activeTab !== 'structure' }"
                (click)="activeTab = 'structure'">
                Structure
            </button>

            <button class="btn"
                [ngClass]="{ 'btn-primary': activeTab === 'sql', 'btn-light': activeTab !== 'sql' }"
                (click)="activeTab = 'sql'">
                Sql
            </button>
        </div>

        <div class="tab-content">

            <!-- Onglet DATA -->
            <div *ngIf="activeTab === 'data'">
                <table *ngIf="lines && lines.length > 0" class="custom-table">
                    <thead>
                        <tr>
                            <th *ngFor="let key of getKeys(lines[0])">{{ key }}</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let row of lines; let i = index" (click)="selectRow(row, i)"
                            [ngClass]="{ 'row-selected': selectedRowIndex === i }">
                            <td *ngFor="let key of getKeys(row)" class="cell-content">
                                <span (dblclick)="onCellTableDblClick($event)">{{ row[key] }}</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Onglet RELATIONS -->
            <div *ngIf="activeTab === 'relations'">
                <app-relations-d3 [data]="relationsData" [focusedTable]="selectedTable">
                </app-relations-d3>
            </div>

            <!-- Onglet STRUCTURE -->
            <div *ngIf="activeTab === 'structure'">
                <div style="margin: 10px 0; height: 500px; overflow-y: auto;">
                    <h3 style="margin-left: 10px;">Column Metadata for Table: {{ selectedTable }}</h3>
                    <table class="table table-bordered table-sm" style="width: 100px; background: white;">
                        <thead class="table-light" style="position: sticky; top: 0; z-index: 2;">
                            <tr>
                                <th style="width: 60%;">Colonne</th>
                                <th style="width: 40%;">Type</th>
                            </tr>
                        </thead>

                        <tbody>
                            <tr *ngFor="let col of columnMetadata ">
                                <td>{{ col.columnName }}</td>
                                <td>{{ col.dataType }}</td>
                            </tr>
                        </tbody>

                    </table>
                </div>
            </div>

            <!-- Onglet SQL -->
            <div *ngIf="activeTab === 'sql'">
                <div style="padding: 10px;">

                    <button (click)="executeSql()">
                        <h3>Execute SQL</h3>
                    </button>
                    <br>

                    <textarea [(ngModel)]="sql" rows="5" cols="100"></textarea><br>

                    <div *ngIf="sqlResult?.length" class="resize-all">
                        <h4>Result:</h4>

                        <table border="1" class="custom-table">
                            <thead>
                                <tr>
                                    <th *ngFor="let key of getKeys(sqlResult[0])">{{ key }}</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let row of sqlResult">
                                    <td *ngFor="let key of getKeys(row)" (click)="colDetails2 = row[key]" class="cell-content"
                                        [title]="row[key]">
                                        {{ row[key] }}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <textarea *ngIf="colDetails2" [(ngModel)]="colDetails2" rows="5" cols="100" style="width: 100%;">
                    </textarea>
                    <br>

                </div>
            </div>

        </div>

    </div>

</div>

<!-- Section métadonnées colonnes -->
<textarea *ngIf="colDetails" [(ngModel)]="colDetails" rows="5" cols="100" style="width: 100%;">
</textarea><br>
